
/* ==== IN√çCIO: analysis-tools.js ==== */
// analysis-tools.js
class AnalysisTools {
    async analyzeQuery(message) {
        return {
            complexity: this.detectComplexity(message),
            intent: this.detectIntent(message),
            urgency: this.detectUrgency(message),
            technicalDepth: this.detectTechnicalDepth(message),
            topics: this.detectTopics(message)
        };
    }
    
    detectComplexity(message) {
        const complexKeywords = ['bug', 'erro', 'otimiza√ß√£o', 'performance', 'arquitetura'];
        return complexKeywords.some(keyword => message.toLowerCase().includes(keyword)) ? 'high' : 'medium';
    }
    
    detectIntent(message) {
        if (message.includes('?')) return 'question';
        if (message.includes('ajuda')) return 'help';
        if (message.match(/n√£o funciona|problema|erro/)) return 'debug';
        return 'general';
    }
    
    detectUrgency(message) {
        const urgentWords = ['urgente', 'cr√≠tico', 'bloqueador', 'produ√ß√£o'];
        return urgentWords.some(word => message.toLowerCase().includes(word)) ? 'high' : 'normal';
    }
    
    detectTechnicalDepth(message) {
        const techWords = ['api', 'endpoint', 'database', 'query', 'function', 'class'];
        const count = techWords.filter(word => message.toLowerCase().includes(word)).length;
        return count > 2 ? 'deep' : count > 0 ? 'medium' : 'shallow';
    }
    
    detectTopics(message) {
        const topics = {
            'javascript': ['javascript', 'js', 'node', 'react', 'vue'],
            'python': ['python', 'django', 'flask'],
            'html': ['html', 'css', 'frontend'],
            'database': ['sql', 'banco de dados', 'query'],
            'api': ['api', 'rest', 'endpoint']
        };
        
        const detectedTopics = [];
        for (const [topic, keywords] of Object.entries(topics)) {
            if (keywords.some(keyword => message.toLowerCase().includes(keyword))) {
                detectedTopics.push(topic);
            }
        }
        
        return detectedTopics;
    }
}
/* ==== FIM: analysis-tools.js ==== */

/* ==== IN√çCIO: app.py ==== */
# app.py - COM CAMINHO ABSOLUTO PARA TEMPLATES
from fastapi import FastAPI
from fastapi.responses import HTMLResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates
import uvicorn
import os

app = FastAPI(title="Chat System", version="1.0.0")

# ‚úÖ CAMINHO ABSOLUTO para templates
current_dir = os.path.dirname(os.path.abspath(__file__))
templates_dir = os.path.join(current_dir, "templates")

print(f"üìÅ Procurando templates em: {templates_dir}")

# Configura templates com caminho absoluto
templates = Jinja2Templates(directory=templates_dir)

# Cria pastas se n√£o existirem
os.makedirs("static/css", exist_ok=True)
os.makedirs("static/js", exist_ok=True)

# Arquivos est√°ticos
app.mount("/static", StaticFiles(directory="static"), name="static")

# Inicializa servi√ßos
try:
    import database
    import auth
    import chat_services
    import ia_services
    import system_info
    print("‚úÖ Todos os servi√ßos carregados")
except Exception as e:
    print(f"‚ö†Ô∏è  Erro nos servi√ßos: {e}")

# Importa e inclui rotas
try:
    from routes import router
    app.include_router(router)
    print("‚úÖ Rotas carregadas")
except Exception as e:
    print(f"‚ö†Ô∏è  Erro nas rotas: {e}")

# ‚úÖ Rota de fallback caso ainda haja problema
@app.get("/fallback")
async def fallback_page():
    html_content = """
    <!DOCTYPE html>
    <html>
    <head>
        <title>Chat System - IA Gratuita</title>
        <link rel="stylesheet" href="/static/css/widgets.css">
        <style>
            body { 
                font-family: Arial, sans-serif; 
                margin: 0; 
                padding: 40px;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                text-align: center;
            }
            .container {
                max-width: 800px;
                margin: 0 auto;
                background: rgba(255,255,255,0.1);
                padding: 40px;
                border-radius: 20px;
                backdrop-filter: blur(10px);
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üöÄ Chat System - Fallback</h1>
            <p>Template carregado via fallback. Widgets funcionando!</p>
            <div class="credential-box" style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3>üîê Credenciais Dev</h3>
                <p><strong>Usu√°rio:</strong> admin</p>
                <p><strong>Senha:</strong> admin123</p>
            </div>
        </div>
        
        <script src="/static/js/user-widget.js"></script>
        <script src="/static/js/dev-widget.js"></script>
    </body>
    </html>
    """
    return HTMLResponse(content=html_content)

if __name__ == "__main__":
    print("üöÄ Chat System - Com Contexto de IA")
    print("üìç Acesse: http://localhost:8000")
    print("üìç Fallback: http://localhost:8000/fallback")
    print("üîê Credenciais: admin / admin123")
    uvicorn.run(app, host="0.0.0.0", port=8000)
/* ==== FIM: app.py ==== */

/* ==== IN√çCIO: auth.py ==== */
# auth.py
import hashlib
import secrets
from datetime import datetime, timedelta
import database

class AuthService:
    def __init__(self):
        self.token_expire_hours = 24
    
    def hash_password(self, password: str) -> str:
        """Hash seguro da senha"""
        return hashlib.sha256(password.encode()).hexdigest()
    
    def verify_password(self, plain_password: str, hashed_password: str) -> bool:
        """Verifica se a senha corresponde ao hash"""
        return self.hash_password(plain_password) == hashed_password
    
    def create_session_token(self, dev_user_id: int) -> str:
        """Cria um token de sess√£o seguro"""
        token = secrets.token_urlsafe(32)
        expires_at = datetime.now() + timedelta(hours=self.token_expire_hours)
        
        conn = database.db.get_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO dev_session_token (token, dev_user_id, expires_at)
            VALUES (?, ?, ?)
        ''', (token, dev_user_id, expires_at))
        
        conn.commit()
        conn.close()
        
        return token
    
    def verify_token(self, token: str) -> dict:
        """Verifica se o token √© v√°lido e retorna dados do usu√°rio"""
        conn = database.db.get_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT st.dev_user_id, st.expires_at, du.username, du.email
            FROM dev_session_token st
            JOIN dev_user du ON st.dev_user_id = du.id
            WHERE st.token = ? AND st.is_active = TRUE
        ''', (token,))
        
        result = cursor.fetchone()
        conn.close()
        
        if not result:
            return None
        
        dev_user_id, expires_at, username, email = result
        
        # Verifica se o token expirou
        if datetime.now() > datetime.fromisoformat(expires_at):
            return None
        
        return {
            "dev_user_id": dev_user_id,
            "username": username,
            "email": email
        }
    
    def login_dev(self, username: str, password: str) -> dict:
        """Login do desenvolvedor"""
        conn = database.db.get_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT id, username, email, password_hash
            FROM dev_user
            WHERE username = ? OR email = ?
        ''', (username, username))
        
        user = cursor.fetchone()
        conn.close()
        
        if not user:
            return {"success": False, "error": "Credenciais inv√°lidas"}
        
        user_id, username, email, password_hash = user
        
        if not self.verify_password(password, password_hash):
            return {"success": False, "error": "Credenciais inv√°lidas"}
        
        token = self.create_session_token(user_id)
        
        return {
            "success": True,
            "token": token,
            "user": {
                "id": user_id,
                "username": username,
                "email": email
            }
        }

# Inst√¢ncia global
auth_service = AuthService()
/* ==== FIM: auth.py ==== */

/* ==== IN√çCIO: chat_services.py ==== */
# chat_services.py
from datetime import datetime
import database
from ia_services import ia_service

class ChatService:
    def __init__(self):
        self.max_history_messages = 10
    
    # === SERVI√áOS DE DEV ===
    
    def create_dev_chat_session(self, dev_user_id: int, title: str = None, session_type: str = "general"):
        """Cria nova sess√£o de chat para dev"""
        if not title:
            title = f"Chat {datetime.now().strftime('%d/%m %H:%M')}"
        
        conn = database.db.get_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO dev_chat_session (dev_user_id, title, session_type, last_interaction)
            VALUES (?, ?, ?, ?)
        ''', (dev_user_id, title, session_type, datetime.now()))
        
        session_id = cursor.lastrowid
        
        conn.commit()
        conn.close()
        
        return self.get_dev_session(session_id)
    
    def get_dev_sessions(self, dev_user_id: int):
        """Lista todas as sess√µes do dev"""
        conn = database.db.get_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT id, title, session_type, model_name, created_at, last_interaction
            FROM dev_chat_session
            WHERE dev_user_id = ?
            ORDER BY last_interaction DESC
        ''', (dev_user_id,))
        
        sessions = []
        for row in cursor.fetchall():
            sessions.append({
                "id": row[0],
                "title": row[1],
                "session_type": row[2],
                "model_name": row[3],
                "created_at": row[4],
                "last_interaction": row[5]
            })
        
        conn.close()
        return sessions
    
    def get_dev_session(self, session_id: int):
        """Busca uma sess√£o espec√≠fica"""
        conn = database.db.get_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT id, dev_user_id, title, session_type, model_name, created_at, last_interaction
            FROM dev_chat_session
            WHERE id = ?
        ''', (session_id,))
        
        row = cursor.fetchone()
        conn.close()
        
        if not row:
            return None
        
        return {
            "id": row[0],
            "dev_user_id": row[1],
            "title": row[2],
            "session_type": row[3],
            "model_name": row[4],
            "created_at": row[5],
            "last_interaction": row[6]
        }
    
    def get_dev_messages(self, session_id: int):
        """Busca mensagens de uma sess√£o"""
        conn = database.db.get_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT role, content, created_at
            FROM dev_chat_message
            WHERE session_id = ?
            ORDER BY created_at ASC
        ''', (session_id,))
        
        messages = []
        for row in cursor.fetchall():
            messages.append({
                "role": row[0],
                "content": row[1],
                "created_at": row[2]
            })
        
        conn.close()
        return messages
    
    def send_dev_message(self, session_id: int, dev_user_id: int, content: str):
        """Envia mensagem na sess√£o dev e obt√©m resposta da IA"""
        # Verifica se a sess√£o pertence ao dev
        session = self.get_dev_session(session_id)
        if not session or session["dev_user_id"] != dev_user_id:
            return {"error": "Sess√£o n√£o encontrada ou acesso negado"}
        
        # Salva mensagem do dev
        conn = database.db.get_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            INSERT INTO dev_chat_message (session_id, role, content)
            VALUES (?, 'dev', ?)
        ''', (session_id, content))
        
        # Atualiza √∫ltima intera√ß√£o
        cursor.execute('''
            UPDATE dev_chat_session 
            SET last_interaction = ? 
            WHERE id = ?
        ''', (datetime.now(), session_id))
        
        conn.commit()
        
        # Busca hist√≥rico para contexto
        cursor.execute('''
            SELECT role, content
            FROM dev_chat_message
            WHERE session_id = ?
            ORDER BY created_at DESC
            LIMIT ?
        ''', (session_id, self.max_history_messages))
        
        history = cursor.fetchall()
        history.reverse()
        
        # Prepara mensagens para a IA
        messages = []
        for role, content in history:
            messages.append({"role": "user" if role == "dev" else "assistant", "content": content})
        
        # Obt√©m resposta da IA
        ia_response = ia_service.dev_chat(messages)
        
        # Salva resposta da IA
        cursor.execute('''
            INSERT INTO dev_chat_message (session_id, role, content)
            VALUES (?, 'ia', ?)
        ''', (session_id, ia_response))
        
        # Atualiza √∫ltima intera√ß√£o novamente
        cursor.execute('''
            UPDATE dev_chat_session 
            SET last_interaction = ? 
            WHERE id = ?
        ''', (datetime.now(), session_id))
        
        conn.commit()
        conn.close()
        
        return {"response": ia_response}
    
    # === SERVI√áOS DE USU√ÅRIO ===
    
    def send_user_message(self, content: str, user_identifier: str = "anonymous"):
        """Processa mensagem do usu√°rio comum"""
        messages = [{"role": "user", "content": content}]
        ia_response = ia_service.user_chat(messages)
        
        return {"response": ia_response}

# Inst√¢ncia global
chat_service = ChatService()
/* ==== FIM: chat_services.py ==== */

/* ==== IN√çCIO: config.py ==== */
# config.py
import os
from dotenv import load_dotenv

load_dotenv()

class Config:
    # Database
    DATABASE_URL = os.getenv('DATABASE_URL', 'sqlite:///chat_system.db')
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production-2024')
    
    # IA Services
    GROQ_API_KEY = os.getenv('GROQ_API_KEY')
    
    # App Settings
    DEBUG = os.getenv('DEBUG', 'True').lower() == 'true'
    TOKEN_EXPIRE_HOURS = 24
    
    # IA Limits
    MAX_TOKENS = 2000
    TEMPERATURE = 0.7
    
    @classmethod
    def validate_config(cls):
        if not cls.GROQ_API_KEY:
            print("‚ö†Ô∏è  GROQ_API_KEY n√£o encontrada - O sistema funcionar√° em modo limitado")
        else:
            print("‚úÖ Configura√ß√£o carregada com sucesso")

Config.validate_config()
/* ==== FIM: config.py ==== */

/* ==== IN√çCIO: database.py ==== */
# database.py
import sqlite3
import hashlib
import os

class Database:
    def __init__(self):
        self.db_path = "chat_system.db"
    
    def get_connection(self):
        return sqlite3.connect(self.db_path, check_same_thread=False)
    
    def init_db(self):
        """Cria todas as tabelas do sistema"""
        try:
            conn = self.get_connection()
            cursor = conn.cursor()
            
            # Tabela de desenvolvedores
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS dev_user (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    username TEXT UNIQUE NOT NULL,
                    email TEXT UNIQUE NOT NULL,
                    password_hash TEXT NOT NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            ''')
            
            # Tabela de tokens de sess√£o
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS dev_session_token (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    token TEXT UNIQUE NOT NULL,
                    dev_user_id INTEGER NOT NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    expires_at TIMESTAMP NOT NULL,
                    is_active BOOLEAN DEFAULT TRUE,
                    FOREIGN KEY (dev_user_id) REFERENCES dev_user (id)
                )
            ''')
            
            # Tabela de sess√µes de chat do dev
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS dev_chat_session (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    dev_user_id INTEGER NOT NULL,
                    title TEXT NOT NULL,
                    session_type TEXT DEFAULT 'general',
                    model_name TEXT DEFAULT 'groq-llama',
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    last_interaction TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    FOREIGN KEY (dev_user_id) REFERENCES dev_user (id)
                )
            ''')
            
            # Tabela de mensagens do dev
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS dev_chat_message (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    session_id INTEGER NOT NULL,
                    role TEXT NOT NULL,
                    content TEXT NOT NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    FOREIGN KEY (session_id) REFERENCES dev_chat_session (id)
                )
            ''')
            
            # Criar usu√°rio dev padr√£o
            password_hash = hashlib.sha256("admin123".encode()).hexdigest()
            cursor.execute('''
                INSERT OR IGNORE INTO dev_user (username, email, password_hash) 
                VALUES (?, ?, ?)
            ''', ("admin", "admin@system.com", password_hash))
            
            conn.commit()
            conn.close()
            print("‚úÖ Banco de dados inicializado com sucesso!")
            return True
            
        except Exception as e:
            print(f"‚ùå Erro no banco de dados: {e}")
            return False

# Inicializa o banco
db = Database()
db.init_db()
/* ==== FIM: database.py ==== */

/* ==== IN√çCIO: dev-widget.js ==== */
class DevWidget {
    constructor() {
        this.isOpen = false;
        this.isAuthenticated = false;
        this.currentSessionId = null;
        this.sessions = [];
        this.token = localStorage.getItem('dev_token');
        this.user = JSON.parse(localStorage.getItem('dev_user') || 'null');
        this.responseHandler = new ResponseHandler();
        this.analysisTools = new AnalysisTools();
        
        this.init();
    }
    
    init() {
        this.createWidget();
        this.bindEvents();
        
        if (this.token && this.user) {
            this.checkAuthentication();
        }
        
        console.log('‚úÖ Widget Dev carregado com melhorias t√©cnicas');
    }
    
    createWidget() {
        const widgetBtn = document.createElement('button');
        widgetBtn.id = 'devWidgetBtn';
        widgetBtn.className = 'widget-btn';
        widgetBtn.innerHTML = 'üîß';
        widgetBtn.title = 'Dev Assistant';
        
        const widgetWindow = document.createElement('div');
        widgetWindow.id = 'devWidgetWindow';
        widgetWindow.className = 'widget-window widget-hidden';
        
        widgetWindow.innerHTML = `
            <div class="dev-container">
                <div class="dev-sidebar">
                    <div class="dev-sessions" id="devSessions"></div>
                    <button class="new-session-btn" id="newSessionBtn">+ Novo</button>
                </div>
                <div class="dev-main">
                    <div class="dev-header">
                        <h3>Assistente Dev</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div class="dev-content" id="devContent"></div>
                </div>
            </div>
        `;
        
        document.body.appendChild(widgetBtn);
        document.body.appendChild(widgetWindow);
        
        this.elements = {
            btn: widgetBtn,
            window: widgetWindow,
            sidebar: document.getElementById('devSessions'),
            content: document.getElementById('devContent'),
            closeBtn: widgetWindow.querySelector('.close-btn'),
            newSessionBtn: document.getElementById('newSessionBtn')
        };
        
        this.showAuthScreen();
    }
    
    bindEvents() {
        this.elements.btn.addEventListener('click', () => this.toggleWidget());
        this.elements.closeBtn.addEventListener('click', () => this.closeWidget());
        this.elements.newSessionBtn.addEventListener('click', () => this.createNewSession());
    }
    
    async checkAuthentication() {
        try {
            const response = await fetch('/api/dev/sessions', {
                headers: {
                    'Authorization': `Bearer ${this.token}`
                }
            });
            
            if (response.ok) {
                this.isAuthenticated = true;
                this.loadSessions();
            } else {
                this.logout();
            }
        } catch (error) {
            console.error('Erro verifica√ß√£o auth:', error);
            this.logout();
        }
    }
    
    showAuthScreen() {
        this.elements.content.innerHTML = `
            <div class="dev-auth">
                <h3 style="text-align: center; margin-bottom: 16px; color: var(--text-color);">Login Dev</h3>
                <input type="text" id="devUsername" class="auth-input" placeholder="Usu√°rio" value="admin">
                <input type="password" id="devPassword" class="auth-input" placeholder="Senha" value="admin123">
                <button id="devLoginBtn" class="auth-btn">Entrar</button>
                <div style="font-size: 12px; color: var(--secondary-color); text-align: center; margin-top: 12px;">
                    Credenciais padr√£o: admin / admin123
                </div>
                <div id="authMessage"></div>
            </div>
        `;
        
        document.getElementById('devLoginBtn').addEventListener('click', () => this.login());
        document.getElementById('devPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.login();
        });
    }
    
    async login() {
        const username = document.getElementById('devUsername').value;
        const password = document.getElementById('devPassword').value;
        const authMessage = document.getElementById('authMessage');
        
        if (!username || !password) {
            this.showMessage(authMessage, 'Preencha todos os campos', 'error');
            return;
        }
        
        try {
            const response = await fetch('/api/dev/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                this.token = data.token;
                this.user = data.user;
                this.isAuthenticated = true;
                
                localStorage.setItem('dev_token', this.token);
                localStorage.setItem('dev_user', JSON.stringify(this.user));
                
                this.showMessage(authMessage, 'Login realizado!', 'success');
                setTimeout(() => {
                    this.loadSessions();
                }, 1000);
                
            } else {
                this.showMessage(authMessage, data.detail || 'Erro no login', 'error');
            }
            
        } catch (error) {
            this.showMessage(authMessage, 'Erro de conex√£o', 'error');
            console.error('Erro login:', error);
        }
    }
    
    logout() {
        this.isAuthenticated = false;
        this.token = null;
        this.user = null;
        this.sessions = [];
        this.currentSessionId = null;
        
        localStorage.removeItem('dev_token');
        localStorage.removeItem('dev_user');
        
        this.showAuthScreen();
    }
    
    async loadSessions() {
        try {
            const response = await fetch('/api/dev/sessions', {
                headers: {
                    'Authorization': `Bearer ${this.token}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                this.sessions = data.sessions;
                this.renderSessions();
                
                if (this.sessions.length > 0 && !this.currentSessionId) {
                    this.selectSession(this.sessions[0].id);
                } else if (this.sessions.length === 0) {
                    this.showEmptyState();
                }
            } else {
                this.logout();
            }
        } catch (error) {
            console.error('Erro carregar sess√µes:', error);
        }
    }
    
    renderSessions() {
        this.elements.sidebar.innerHTML = '';
        
        this.sessions.forEach(session => {
            const sessionEl = document.createElement('div');
            sessionEl.className = `session-item ${session.id === this.currentSessionId ? 'session-active' : ''}`;
            sessionEl.innerHTML = `
                <div style="font-weight: ${session.id === this.currentSessionId ? 'bold' : 'normal'}">
                    ${session.title}
                </div>
                <div style="font-size: 10px; color: var(--secondary-color); margin-top: 4px;">
                    ${new Date(session.last_interaction).toLocaleDateString()}
                </div>
            `;
            
            sessionEl.addEventListener('click', () => this.selectSession(session.id));
            this.elements.sidebar.appendChild(sessionEl);
        });
    }
    
    async selectSession(sessionId) {
        this.currentSessionId = sessionId;
        this.renderSessions();
        await this.loadSessionMessages(sessionId);
    }
    
    async loadSessionMessages(sessionId) {
        try {
            const response = await fetch(`/api/dev/sessions/${sessionId}/messages`, {
                headers: {
                    'Authorization': `Bearer ${this.token}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                this.showChatInterface(data.messages);
            }
        } catch (error) {
            console.error('Erro carregar mensagens:', error);
        }
    }
    
    addMessage(role, content) {
        if (!this.elements.devMessages) {
            console.error('devMessages n√£o est√° definido');
            return;
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role === 'dev' ? 'user-message' : 'ia-message'}`;
        
        // Processa o conte√∫do para manter formata√ß√£o
        const processedContent = this.responseHandler.cleanResponse(content);
        messageDiv.innerHTML = processedContent;
        
        this.elements.devMessages.appendChild(messageDiv);
        this.scrollToBottom();
        this.checkScrollable();
    }
    

    showChatInterface(messages = []) {
        this.elements.content.innerHTML = `
            <div class="dev-messages" id="devMessages">
                ${messages.map(msg => `
                    <div class="message ${msg.role === 'dev' ? 'user-message' : 'ia-message'}">
                        ${this.escapeHtml(msg.content)}
                    </div>
                `).join('')}
            </div>
            <div class="dev-input-area">
                <div class="dev-input-group">
                    <textarea 
                        id="devMessageInput" 
                        placeholder="Digite sua pergunta t√©cnica..."
                        
                    ></textarea>
                    <button id="devSendBtn">Enviar</button>
                </div>
            </div>
        `;
        
        this.bindChatEvents();
        this.scrollToBottom();
        this.checkScrollable(); // ‚úÖ Nova fun√ß√£o
    }

    // ‚úÖ Nova fun√ß√£o para verificar se precisa de scroll
    checkScrollable() {
        if (this.elements.devMessages) {
            const messages = this.elements.devMessages;
            const isScrollable = messages.scrollHeight > messages.clientHeight;
            
            if (isScrollable) {
                messages.classList.add('scrollable');
            } else {
                messages.classList.remove('scrollable');
            }
        }
    }

    // ‚úÖ Fun√ß√£o para escapar HTML (seguran√ßa)
    escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }




    bindChatEvents() {
        const input = document.getElementById('devMessageInput');
        const sendBtn = document.getElementById('devSendBtn');
        const messagesContainer = document.getElementById('devMessages');
        
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            sendBtn.disabled = !this.value.trim();
        });
        
        sendBtn.addEventListener('click', () => this.sendDevMessage());
        
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!sendBtn.disabled) {
                    this.sendDevMessage();
                }
            }
        });
        
        this.elements.devMessages = messagesContainer;
        this.elements.devInput = input;
        this.elements.devSendBtn = sendBtn;
    }
    
    async sendDevMessage() {
        const message = this.elements.devInput.value.trim();
        if (!message || !this.currentSessionId) return;
        
        // ‚úÖ AGORA addMessage EXISTE
        this.addMessage('dev', message);
        this.elements.devInput.value = '';
        this.elements.devInput.style.height = 'auto';
        this.elements.devSendBtn.disabled = true;
        
        this.showDevTypingIndicator();
        
        try {
            const analysis = await this.analysisTools.analyzeQuery(message);
            const response = await this.getTechnicalResponse(message, analysis);
            const processedResponse = await this.responseHandler.processResponse(response, 'dev');
            
            this.hideDevTypingIndicator();
            await this.showTechnicalResponse(processedResponse, analysis);
            
        } catch (error) {
            this.hideDevTypingIndicator();
            // ‚úÖ AGORA addMessage EXISTE
            this.addMessage('ia', this.getTechnicalErrorMessage(error));
        }
    }
    
    async showTechnicalResponse(response, analysis) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message dev-ia-message technical-response';
        this.elements.devMessages.appendChild(messageDiv);
        
        if (analysis.complexity === 'high') {
            const header = document.createElement('div');
            header.className = 'tech-header';
            header.innerHTML = 'üîß <strong>An√°lise T√©cnica Detalhada</strong>';
            messageDiv.appendChild(header);
        }
        
        await this.responseHandler.typeMessage(messageDiv, response, 20);
        this.addTechnicalTools(messageDiv, analysis);
        this.logTechnicalAnalysis(analysis);
    }
    
    addTechnicalTools(messageElement, analysis) {
        const toolsContainer = document.createElement('div');
        toolsContainer.className = 'tech-tools';
        
        const tools = [
            { label: 'üìä An√°lise Detalhada', action: 'detailed_analysis' },
            { label: 'üêõ Debug', action: 'debug' },
            { label: 'üìù Exemplo Pr√°tico', action: 'practical_example' },
            { label: 'üîç Performance', action: 'performance' }
        ];
        
        tools.forEach(tool => {
            const button = document.createElement('button');
            button.className = 'tech-tool-btn';
            button.textContent = tool.label;
            button.onclick = () => this.handleTechnicalTool(tool.action, analysis);
            toolsContainer.appendChild(button);
        });
        
        messageElement.appendChild(toolsContainer);
    }
    
    handleTechnicalTool(action, analysis) {
        switch (action) {
            case 'detailed_analysis':
                this.requestDetailedAnalysis(analysis);
                break;
            case 'debug':
                this.requestDebugTools(analysis);
                break;
            case 'practical_example':
                this.requestPracticalExample(analysis);
                break;
            case 'performance':
                this.requestPerformanceAnalysis(analysis);
                break;
        }
    }
    
    requestDetailedAnalysis(analysis) {
        this.addMessage('dev', `Solicito an√°lise detalhada sobre: ${analysis.topics.join(', ')}`);
        this.sendDevMessage();
    }
    
    requestDebugTools(analysis) {
        this.addMessage('dev', `Preciso de ferramentas de debug para: ${analysis.topics.join(', ')}`);
        this.sendDevMessage();
    }
    
    requestPracticalExample(analysis) {
        this.addMessage('dev', `Mostre um exemplo pr√°tico para: ${analysis.topics.join(', ')}`);
        this.sendDevMessage();
    }
    
    requestPerformanceAnalysis(analysis) {
        this.addMessage('dev', `Analise a performance para: ${analysis.topics.join(', ')}`);
        this.sendDevMessage();
    }
    
    async getTechnicalResponse(message, analysis) {
        // Simula resposta t√©cnica - substitua pela sua API real
        return new Promise((resolve) => {
            setTimeout(() => {
                const techResponses = [
                    `üîç **An√°lise T√©cnica:**\n\nDetectei que voc√™ est√° trabalhando com ${analysis.topics.join(', ')}. Baseado na complexidade ${analysis.complexity}, recomendo:\n\n‚Ä¢ Verificar os logs do sistema\n‚Ä¢ Testar em ambiente de desenvolvimento\n‚Ä¢ Revisar a documenta√ß√£o da API`,
                    `üíª **Solu√ß√£o T√©cnica:**\n\nPara o problema identificado (${analysis.intent}), sugiro esta abordagem:\n\n\`\`\`javascript\n// Exemplo de solu√ß√£o\nfunction solveIssue() {\n  // Implementa√ß√£o t√©cnica\n  console.log("Solu√ß√£o aplicada");\n}\n\`\`\``,
                    `üêõ **Debug Recomendado:**\n\nBaseado na an√°lise, identifiquei poss√≠veis pontos de falha. Recomendo:\n\n1. Verificar autentica√ß√£o\n2. Testar endpoints\n3. Validar dados de entrada\n4. Revisar permiss√µes`
                ];
                resolve(techResponses[Math.floor(Math.random() * techResponses.length)]);
            }, 1500);
        });
    }
    
    getTechnicalErrorMessage(error) {
        console.error('Erro t√©cnico:', error);
        this.logError(error);
        
        const techErrorMessages = {
            'debug_failed': 'üîß Falha na an√°lise de debug. Verifique os logs.',
            'code_analysis_failed': 'üìä An√°lise de c√≥digo n√£o conclu√≠da.',
            'timeout': '‚è∞ An√°lise t√©cnica est√° demorando.',
            'default': '‚ùå Falha t√©cnica. Consulte o console.'
        };
        
        return techErrorMessages.default;
    }
    
    logTechnicalAnalysis(analysis) {
        console.group('üîç An√°lise T√©cnica');
        console.log('Complexidade:', analysis.complexity);
        console.log('T√≥picos:', analysis.topics);
        console.log('Inten√ß√£o:', analysis.intent);
        console.log('Profundidade:', analysis.technicalDepth);
        console.groupEnd();
    }
    
    logError(error) {
        console.group('üö® Erro T√©cnico Detalhado');
        console.error('Mensagem:', error.message);
        console.error('Stack:', error.stack);
        console.error('Status:', error.status);
        console.groupEnd();
    }
    

    
    showDevTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.id = 'devTypingIndicator';
        typingDiv.className = 'typing-indicator';
        typingDiv.innerHTML = `
            IA analisando...
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        `;
        
        this.elements.devMessages.appendChild(typingDiv);
        this.scrollToBottom();
    }
    
    hideDevTypingIndicator() {
        const typingIndicator = document.getElementById('devTypingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }
    
    async createNewSession() {
        try {
            const response = await fetch('/api/dev/sessions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.token}`
                },
                body: JSON.stringify({
                    title: `Chat ${new Date().toLocaleTimeString()}`,
                    session_type: 'code_analysis'
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                await this.loadSessions();
                this.selectSession(data.session.id);
            }
        } catch (error) {
            console.error('Erro criar sess√£o:', error);
        }
    }
    
    showEmptyState() {
        this.elements.content.innerHTML = `
            <div class="empty-state">
                <div style="font-size: 48px; margin-bottom: 16px;">üí¨</div>
                <h3>Nenhum chat ainda</h3>
                <p style="margin: 8px 0 16px 0;">Comece uma nova conversa t√©cnica</p>
                <button class="auth-btn" onclick="devWidget.createNewSession()">Criar Primeiro Chat</button>
            </div>
        `;
    }
    
    showMessage(element, message, type) {
        element.innerHTML = `<div class="${type}-message">${message}</div>`;
    }
    
    scrollToBottom() {
        if (this.elements.devMessages) {
            // Pequeno delay para garantir que o DOM foi atualizado
            setTimeout(() => {
                this.elements.devMessages.scrollTop = this.elements.devMessages.scrollHeight;
            }, 50);
        }
    }
    
    toggleWidget() {
        this.isOpen = !this.isOpen;
        
        if (this.isOpen) {
            this.elements.window.classList.remove('widget-hidden');
            this.elements.window.classList.add('widget-visible');
            
            if (this.isAuthenticated && this.elements.devInput) {
                this.elements.devInput.focus();
            }
        } else {
            this.closeWidget();
        }
    }
    
    closeWidget() {
        this.isOpen = false;
        this.elements.window.classList.remove('widget-visible');
        this.elements.window.classList.add('widget-hidden');
    }
}

// Inst√¢ncia global
let devWidget;

// Inicializa quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', () => {
    devWidget = new DevWidget();
});
/* ==== FIM: dev-widget.js ==== */

/* ==== IN√çCIO: ia_services.py ==== */
# ia_services.py - COM CONTEXTO DO SISTEMA
import os
from openai import OpenAI
from dotenv import load_dotenv

load_dotenv()

class IAService:
    def __init__(self):
        self.groq_key = os.environ.get("GROQ_API_KEY")
        self.use_real_ia = bool(self.groq_key)
        
        if self.use_real_ia:
            print("‚úÖ IA Groq configurada")
        else:
            print("‚ö†Ô∏è  Modo MOCK - Configure GROQ_API_KEY no .env")
    
    # Atualize as system_context no ia_services.py para:
    def dev_chat(self, messages):
        from system_info import system_info
        
        tech_info = system_info.get_tech_context()
        system_context = f"""
        VOC√ä √â UM ASSISTENTE T√âCNICO ESPECIALIZADO NO SISTEMA ONDE EST√Å IMPLEMENTADO.

        CONTEXTO T√âCNICO DO SISTEMA ATUAL:
        Nome: Chat System - IA Gratuita
        Arquitetura: {tech_info['architecture']['backend']['framework']} + {tech_info['architecture']['backend']['database']}
        
        ESTRUTURA T√âCNICA:
        - Backend: FastAPI com SQLite
        - Frontend: JavaScript vanilla + CSS customizado
        - IA: Groq API com fallback para mock
        - Autentica√ß√£o: Sistema pr√≥prio com tokens
        
        SUAS FUN√á√ïES ESPEC√çFICAS NESTE SISTEMA:
        1. Analisar e corrigir c√≥digos DO PR√ìPRIO SISTEMA
        2. Sugerir melhorias na arquitetura ATUAL
        3. Debug de problemas t√©cnicos ESPEC√çFICOS
        4. Explicar como o sistema funciona INTERNAMENTE
        5. Ajudar a expandir funcionalidades EXISTENTES

        VOC√ä TEM ACESSO A:
        - Todo o c√≥digo-fonte do sistema
        - Estrutura de banco de dados
        - API endpoints dispon√≠veis
        - Sistema de autentica√ß√£o

        REGRAS CR√çTICAS:
        - SEMPRE referencie que est√° falando do SISTEMA ATUAL
        - Use exemplos de c√≥digo ESPEC√çFICOS deste sistema
        - Quando analisar problemas, considere a arquitetura REAL
        - Sugira solu√ß√µes PR√ÅTICAS para a stack atual

        Exemplo de resposta contextualizada:
        "No SEU sistema Chat System, o arquivo app.py usa FastAPI... 
        Para corrigir isso no SEU c√≥digo, modifique a linha X no arquivo Y..."

        Responda em portugu√™s t√©cnico e espec√≠fico.
        """
        
        return self._groq_chat(messages, "llama-3.1-8b-instant", system_context)

    def user_chat(self, messages):
        from system_info import system_info
        
        sys_info = system_info.get_system_context()
        system_context = f"""
        VOC√ä √â UM ASSISTENTE DO SITE "{sys_info['system_name']}" ONDE EST√Å IMPLEMENTADO.

        INFORMA√á√ïES DO SITE ATUAL:
        - Nome: {sys_info['system_name']}
        - Vers√£o: {sys_info['version']}
        - Descri√ß√£o: Sistema de chat com IA gratuita

        FUNCIONALIDADES DISPON√çVEIS:
        {' | '.join(sys_info['features'])}

        COMO USAR ESTE SITE ESPEC√çFICO:

        Widget Usu√°rio ({sys_info['widgets'][0]['icon']}):
        - Posi√ß√£o: {sys_info['widgets'][0]['position']}
        - Fun√ß√£o: {sys_info['widgets'][0]['purpose']}
        - Acesso: Livre para todos

        Widget Desenvolvedor ({sys_info['widgets'][1]['icon']}):
        - Posi√ß√£o: {sys_info['widgets'][1]['position']}
        - Fun√ß√£o: {sys_info['widgets'][1]['purpose']}
        - Login: {sys_info['widgets'][1]['credentials']}

        SUAS RESPONSABILIDADES:
        - Explicar como ESTE site funciona
        - Ajudar usu√°rios a usar OS WIDGETS ESPEC√çFICOS
        - Orientar sobre as funcionalidades REAIS dispon√≠veis
        - Direcionar para o widget apropriado

        REGRAS IMPORTANTES:
        - SEMPRE mencione que est√° falando DESTE site espec√≠fico
        - Refira-se aos widgets pelos seus √≠cones e posi√ß√µes REAIS
        - Explique que h√° dois tipos de assistentes NESTE sistema
        - Seja espec√≠fico sobre as credenciais de desenvolvedor

        Exemplo de resposta contextualizada:
        "No NOSSO site Chat System, voc√™ tem duas op√ß√µes: 
        Use o bot√£o üí¨ no canto direito para ajuda geral, ou 
        o bot√£o üîß no canto esquerdo para an√°lise t√©cnica..."

        Responda em portugu√™s claro e amig√°vel.
        """
        
        return self._groq_chat(messages, "llama-3.1-8b-instant", system_context)
    
    def _groq_chat(self, messages, model, system_context):
        # Modo MOCK se n√£o tiver chave
        if not self.use_real_ia:
            last_msg = messages[-1]['content'] if messages else "Ol√°"
            if "c√≥digo" in last_msg.lower() or "sistema" in last_msg.lower():
                return f"üîß [MOCK] No Chat System: '{last_msg}'. Configure GROQ_API_KEY para respostas t√©cnicas reais."
            else:
                return f"ü§ñ [MOCK] No site Chat System: '{last_msg}'. Configure Groq para respostas completas sobre este sistema."
        
        # IA Real com contexto espec√≠fico
        try:
            client = OpenAI(
                api_key=self.groq_key,
                base_url="https://api.groq.com/openai/v1"
            )
            
            # Adiciona o contexto do sistema como primeira mensagem
            system_msg = {"role": "system", "content": system_context}
            full_messages = [system_msg] + messages
            
            response = client.chat.completions.create(
                model=model,
                messages=full_messages,
                temperature=0.7,
                max_tokens=2000
            )
            return response.choices[0].message.content
            
        except Exception as e:
            return f"‚ùå Erro na IA: {str(e)}"

# Inst√¢ncia global
ia_service = IAService()
/* ==== FIM: ia_services.py ==== */

/* ==== IN√çCIO: response-handler.js ==== */
// response-handler.js
class ResponseHandler {
    constructor() {
        this.typingSpeed = 30;
        this.thinkingTime = 800;
    }

    async processResponse(response, messageType = 'user') {
        let processedResponse = this.cleanResponse(response);
        const contentType = this.detectContentType(processedResponse);
        processedResponse = this.formatByContentType(processedResponse, contentType);
        processedResponse = this.addContextualEmojis(processedResponse, contentType);
        return processedResponse;
    }

    cleanResponse(text) {
        if (!text) return 'Desculpe, n√£o consegui processar a resposta.';
        
        return text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/\n{3,}/g, '\n\n')
            .replace(/\s+\./g, '.')
            .trim();
    }

    detectContentType(text) {
        const lowerText = text.toLowerCase();
        
        if (lowerText.includes('erro') || lowerText.includes('error') || 
            lowerText.includes('n√£o funciona') || lowerText.includes('problema')) {
            return 'error';
        }
        
        if (lowerText.includes('c√≥digo') || lowerText.includes('code') || 
            lowerText.match(/function|class|const|let|var|def |import |export /)) {
            return 'code';
        }
        
        if (lowerText.includes('```') || lowerText.includes('python') || 
            lowerText.includes('javascript') || lowerText.includes('html')) {
            return 'code_block';
        }
        
        if (lowerText.includes('exemplo') || lowerText.includes('exemplo:') || 
            lowerText.includes('por exemplo')) {
            return 'example';
        }
        
        if (lowerText.includes('dica') || lowerText.includes('sugest√£o') || 
            lowerText.includes('recomenda√ß√£o')) {
            return 'tip';
        }
        
        if (lowerText.match(/passo a passo|como fazer|tutorial/)) {
            return 'tutorial';
        }
        
        return 'general';
    }

    formatByContentType(text, contentType) {
        switch (contentType) {
            case 'code':
                return this.formatCodeResponse(text);
            case 'code_block':
                return this.formatCodeBlock(text);
            case 'error':
                return this.formatErrorResponse(text);
            case 'tip':
                return this.formatTipResponse(text);
            case 'tutorial':
                return this.formatTutorialResponse(text);
            case 'example':
                return this.formatExampleResponse(text);
            default:
                return this.formatGeneralResponse(text);
        }
    }

    formatCodeResponse(text) {
        return text.replace(/```(\w+)?\n([\s\S]*?)```/g, 
            '<div class="code-block"><div class="code-header">$1</div><pre><code>$2</code></pre></div>');
    }

    formatCodeBlock(text) {
        return `<div class="code-container">${text}</div>`;
    }

    formatErrorResponse(text) {
        return `üö® <strong>Problema Detectado:</strong>\n\n${text}\n\nüí° <strong>Sugest√£o de Solu√ß√£o:</strong>`;
    }

    formatTipResponse(text) {
        return `üí° <strong>Dica Profissional:</strong>\n\n${text}`;
    }

    formatTutorialResponse(text) {
        const steps = text.split(/\d+\./).filter(step => step.trim());
        let formatted = `üìö <strong>Passo a Passo:</strong>\n\n`;
        
        steps.forEach((step, index) => {
            formatted += `${index + 1}. ${step.trim()}\n\n`;
        });
        
        return formatted;
    }

    formatExampleResponse(text) {
        return `üìã <strong>Exemplo Pr√°tico:</strong>\n\n${text}`;
    }

    formatGeneralResponse(text) {
        const paragraphs = text.split('\n\n');
        return paragraphs.map(p => {
            if (p.startsWith('- ') || p.startsWith('‚Ä¢ ')) {
                return `‚Ä¢ ${p.substring(2)}`;
            }
            return p;
        }).join('\n\n');
    }

    addContextualEmojis(text, contentType) {
        const emojis = {
            'error': 'üö®',
            'code': 'üíª',
            'code_block': 'üìù',
            'tip': 'üí°',
            'tutorial': 'üìö',
            'example': 'üìã',
            'general': 'ü§ñ'
        };
        
        const emoji = emojis[contentType] || 'üí¨';
        return `${emoji} ${text}`;
    }

    async typeMessage(element, message, speed = this.typingSpeed) {
        element.innerHTML = '';
        await this.delay(this.thinkingTime);
        
        for (let i = 0; i < message.length; i++) {
            element.innerHTML += message[i];
            element.parentElement.scrollTop = element.parentElement.scrollHeight;
            
            const currentChar = message[i];
            const nextChar = message[i + 1];
            let charSpeed = speed;
            
            if (currentChar.match(/[.,;!?]/)) {
                charSpeed = speed * 3;
            } else if (nextChar && nextChar.match(/[.,;!?]/)) {
                charSpeed = speed * 1.5;
            }
            
            await this.delay(charSpeed);
        }
    }

    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}
/* ==== FIM: response-handler.js ==== */

/* ==== IN√çCIO: routes.py ==== */
# routes.py
from fastapi import APIRouter, HTTPException, Header, Request
from fastapi.responses import HTMLResponse, JSONResponse
from fastapi.templating import Jinja2Templates
from pydantic import BaseModel
import auth
import chat_services
import os

# ‚úÖ Configura templates
templates = Jinja2Templates(directory="templates")

# ‚úÖ Define o router
router = APIRouter()

# Models
class LoginRequest(BaseModel):
    username: str
    password: str

class DevMessageRequest(BaseModel):
    session_id: int
    content: str

class UserMessageRequest(BaseModel):
    content: str
    user_identifier: str = "anonymous"

class CreateSessionRequest(BaseModel):
    title: str = None
    session_type: str = "general"

# === ROTA PRINCIPAL COM HTML ===
@router.get("/", response_class=HTMLResponse)
async def main_page(request: Request):
    """P√°gina principal com interface completa"""
    return templates.TemplateResponse("base.html", {"request": request})

# === ROTAS DE AUTENTICA√á√ÉO ===
@router.post("/api/dev/login")
async def dev_login(login_data: LoginRequest):
    result = auth.auth_service.login_dev(login_data.username, login_data.password)
    if not result["success"]:
        raise HTTPException(status_code=401, detail=result["error"])
    return result

# === ROTAS DE CHAT ===
@router.get("/api/dev/sessions")
async def get_dev_sessions(authorization: str = Header(None)):
    user_data = _get_user_from_token(authorization)
    sessions = chat_services.chat_service.get_dev_sessions(user_data["dev_user_id"])
    return {"sessions": sessions}

@router.post("/api/dev/sessions")
async def create_dev_session(session_data: CreateSessionRequest, authorization: str = Header(None)):
    user_data = _get_user_from_token(authorization)
    session = chat_services.chat_service.create_dev_chat_session(
        user_data["dev_user_id"], 
        session_data.title,
        session_data.session_type
    )
    return {"session": session}

@router.get("/api/dev/sessions/{session_id}/messages")
async def get_dev_messages(session_id: int, authorization: str = Header(None)):
    user_data = _get_user_from_token(authorization)
    session = chat_services.chat_service.get_dev_session(session_id)
    if not session or session["dev_user_id"] != user_data["dev_user_id"]:
        raise HTTPException(status_code=404, detail="Sess√£o n√£o encontrada")
    messages = chat_services.chat_service.get_dev_messages(session_id)
    return {"messages": messages}

@router.post("/api/dev/send-message")
async def send_dev_message(message_data: DevMessageRequest, authorization: str = Header(None)):
    user_data = _get_user_from_token(authorization)
    result = chat_services.chat_service.send_dev_message(
        message_data.session_id,
        user_data["dev_user_id"],
        message_data.content
    )
    if "error" in result:
        raise HTTPException(status_code=400, detail=result["error"])
    return {"response": result["response"]}

@router.post("/api/user/send-message")
async def send_user_message(message_data: UserMessageRequest):
    result = chat_services.chat_service.send_user_message(
        message_data.content,
        message_data.user_identifier
    )
    return {"response": result["response"]}

# === ROTAS DE HEALTH ===
@router.get("/health")
async def health():
    return {"status": "healthy", "service": "Chat System"}

@router.get("/api/health")
async def api_health():
    return {
        "status": "online", 
        "version": "1.0.0",
        "features": ["fastapi", "sqlite", "ia_gratuita", "widgets"]
    }

# === FUN√á√ïES AUXILIARES ===
def _get_user_from_token(authorization: str):
    if not authorization or not authorization.startswith("Bearer "):
        raise HTTPException(status_code=401, detail="Token necess√°rio")
    token = authorization[7:]
    user_data = auth.auth_service.verify_token(token)
    if not user_data:
        raise HTTPException(status_code=401, detail="Token inv√°lido")
    return user_data
/* ==== FIM: routes.py ==== */

/* ==== IN√çCIO: run.py ==== */
#!/usr/bin/env python3
"""
Script para executar o Chat System com IA Gratuita
"""

import uvicorn
import os
import webbrowser
from datetime import datetime

def main():
    print("üöÄ INICIANDO CHAT SYSTEM - IA GRATUITA")
    print("=" * 50)
    
    # Verifica se o .env existe
    if not os.path.exists('chat_system/.env'):
        print("‚ùå Arquivo .env n√£o encontrado!")
        print("üìã Crie um arquivo .env com:")
        print("""
GROQ_API_KEY=sua_chave_groq_aqui
DATABASE_URL=sqlite:///chat_system.db
SECRET_KEY=sua_chave_secreta
DEBUG=True
        """)
        return
    
    # Verifica depend√™ncias
    try:
        import fastapi
        import sqlite3
        import openai
        print("‚úÖ Todas as depend√™ncias encontradas")
    except ImportError as e:
        print(f"‚ùå Depend√™ncia faltando: {e}")
        print("üì¶ Execute: pip install -r requirements.txt")
        return
    
    print("üìä Configura√ß√£o do sistema:")
    print(f"   ‚Ä¢ Database: {os.getenv('DATABASE_URL', 'sqlite:///chat_system.db')}")
    print(f"   ‚Ä¢ IA Service: {'Groq ‚úÖ' if os.getenv('GROQ_API_KEY') else 'Mock Mode ‚ö†Ô∏è'}")
    print(f"   ‚Ä¢ Debug: {os.getenv('DEBUG', 'True')}")
    
    print("\nüéØ URLs do sistema:")
    print("   ‚Ä¢ Frontend: http://localhost:8000")
    print("   ‚Ä¢ API Docs: http://localhost:8000/docs")
    print("\nüìç Credenciais padr√£o:")
    print("   ‚Ä¢ Usu√°rio: admin")
    print("   ‚Ä¢ Senha: admin123")
    print("\n" + "=" * 50)
    
    # Pergunta se quer abrir o navegador
    try:
        choice = input("Abrir navegador automaticamente? (s/N): ").strip().lower()
        if choice in ['s', 'sim', 'y', 'yes']:
            webbrowser.open('http://localhost:8000')
    except:
        pass
    
    print("‚è≥ Iniciando servidor... (Ctrl+C para parar)")
    
    # Inicia o servidor
    uvicorn.run(
        "app:app",
        host="0.0.0.0",
        port=8000,
        reload=True,
        log_level="info"
    )

if __name__ == "__main__":
    main()
/* ==== FIM: run.py ==== */

/* ==== IN√çCIO: system_info.py ==== */
# system_info.py
import os
import sys
from datetime import datetime

class SystemInfo:
    @staticmethod
    def get_system_context():
        """Retorna informa√ß√µes din√¢micas do sistema"""
        return {
            "system_name": "Chat System - IA Gratuita",
            "version": "1.0.0",
            "backend": "FastAPI + SQLite",
            "frontend": "HTML/CSS/JS Vanilla",
            "ia_provider": "Groq API (Llama 3.1)",
            "widgets": [
                {
                    "name": "Widget Usu√°rio",
                    "icon": "üí¨",
                    "position": "canto inferior direito",
                    "purpose": "Chat geral de suporte"
                },
                {
                    "name": "Widget Desenvolvedor", 
                    "icon": "üîß",
                    "position": "canto inferior esquerdo",
                    "purpose": "An√°lise t√©cnica e debug",
                    "login_required": True,
                    "credentials": "admin / admin123"
                }
            ],
            "features": [
                "IA 100% gratuita",
                "M√∫ltiplas sess√µes de chat",
                "Autentica√ß√£o segura",
                "Hist√≥rico de conversas",
                "Interface responsiva"
            ],
            "current_time": datetime.now().isoformat(),
            "python_version": sys.version,
            "environment": "production" if not os.getenv('DEBUG') else "development"
        }
    
    @staticmethod
    def get_tech_context():
        """Retorna contexto t√©cnico detalhado"""
        return {
            "architecture": {
                "backend": {
                    "framework": "FastAPI",
                    "database": "SQLite",
                    "auth": "Sistema pr√≥prio com tokens JWT-like",
                    "api_style": "RESTful"
                },
                "frontend": {
                    "approach": "Vanilla JavaScript",
                    "styling": "CSS customizado",
                    "widgets": "Web Components nativos",
                    "state_management": "LocalStorage + Mem√≥ria"
                },
                "ia_integration": {
                    "provider": "Groq",
                    "model": "llama-3.1-8b-instant", 
                    "fallback": "Modo Mock quando sem chave"
                }
            },
            "file_structure": """
            chat_system/
            ‚îú‚îÄ‚îÄ app.py                 # Aplica√ß√£o principal
            ‚îú‚îÄ‚îÄ database.py           # Modelos DB
            ‚îú‚îÄ‚îÄ auth.py               # Autentica√ß√£o
            ‚îú‚îÄ‚îÄ chat_services.py      # L√≥gica de neg√≥cio
            ‚îú‚îÄ‚îÄ ia_services.py        # Integra√ß√£o IA
            ‚îú‚îÄ‚îÄ routes.py             # Rotas API
            ‚îú‚îÄ‚îÄ system_info.py        # Informa√ß√µes sistema
            ‚îú‚îÄ‚îÄ templates/
            ‚îÇ   ‚îî‚îÄ‚îÄ base.html         # HTML principal
            ‚îî‚îÄ‚îÄ static/
                ‚îú‚îÄ‚îÄ css/
                ‚îÇ   ‚îî‚îÄ‚îÄ widgets.css   # Estilos
                ‚îî‚îÄ‚îÄ js/
                    ‚îú‚îÄ‚îÄ user-widget.js
                    ‚îî‚îÄ‚îÄ dev-widget.js
            """
        }

# Inst√¢ncia global
system_info = SystemInfo()
/* ==== FIM: system_info.py ==== */

/* ==== IN√çCIO: user-widget.js ==== */
// user-widget.js
class UserWidget {
    constructor() {
        this.isOpen = false;
        this.responseHandler = new ResponseHandler();
        this.init();
    }
    
    init() {
        this.createWidget();
        this.bindEvents();
        console.log('‚úÖ Widget Usu√°rio carregado com melhorias');
    }
    
    createWidget() {
        const widgetBtn = document.createElement('button');
        widgetBtn.id = 'userWidgetBtn';
        widgetBtn.className = 'widget-btn';
        widgetBtn.innerHTML = 'üí¨';
        widgetBtn.title = 'Assistente Virtual';
        
        const widgetWindow = document.createElement('div');
        widgetWindow.id = 'userWidgetWindow';
        widgetWindow.className = 'widget-window widget-hidden';
        
        widgetWindow.innerHTML = `
            <div class="user-header">
                <h3>Assistente Virtual</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="user-messages" id="userMessages"></div>
            <div class="user-input-area">
                <div class="user-input-group">
                    <input type="text" id="userMessageInput" placeholder="Digite sua mensagem...">
                    <button id="userSendBtn" disabled>Enviar</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(widgetBtn);
        document.body.appendChild(widgetWindow);
        
        this.elements = {
            btn: widgetBtn,
            window: widgetWindow,
            messages: document.getElementById('userMessages'),
            input: document.getElementById('userMessageInput'),
            sendBtn: document.getElementById('userSendBtn'),
            closeBtn: widgetWindow.querySelector('.close-btn')
        };
    }
    
    bindEvents() {
        this.elements.btn.addEventListener('click', () => this.toggleWidget());
        this.elements.closeBtn.addEventListener('click', () => this.closeWidget());
        this.elements.sendBtn.addEventListener('click', () => this.sendUserMessage());
        
        this.elements.input.addEventListener('input', () => {
            this.elements.sendBtn.disabled = !this.elements.input.value.trim();
        });
        
        this.elements.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !this.elements.sendBtn.disabled) {
                this.sendUserMessage();
            }
        });
    }
    
    async sendUserMessage() {
        const message = this.elements.input.value.trim();
        if (!message) return;
        
        this.addMessage('user', message);
        this.elements.input.value = '';
        this.elements.sendBtn.disabled = true;
        
        this.showTypingIndicator();
        
        try {
            const response = await this.getAIResponse(message);
            const processedResponse = await this.responseHandler.processResponse(response, 'user');
            
            this.hideTypingIndicator();
            await this.showAIResponse(processedResponse);
            
        } catch (error) {
            this.hideTypingIndicator();
            this.addMessage('ai', this.getErrorMessage(error));
        }
    }
    
    async showAIResponse(response) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ai-message';
        this.elements.messages.appendChild(messageDiv);
        
        await this.responseHandler.typeMessage(messageDiv, response);
        this.addActionButtons(messageDiv, response);
        this.scrollToBottom();
    }
    
    addActionButtons(messageElement, response) {
        const actions = this.detectActions(response);
        
        if (actions.length > 0) {
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'action-buttons';
            
            actions.forEach(action => {
                const button = document.createElement('button');
                button.className = 'action-btn';
                button.textContent = action.label;
                button.onclick = () => this.handleAction(action);
                buttonContainer.appendChild(button);
            });
            
            messageElement.appendChild(buttonContainer);
        }
    }
    
    detectActions(response) {
        const actions = [];
        const lowerResponse = response.toLowerCase();
        
        if (lowerResponse.includes('c√≥digo') || lowerResponse.includes('exemplo')) {
            actions.push({
                label: 'üìã Copiar C√≥digo',
                type: 'copy_code',
                data: response
            });
        }
        
        if (lowerResponse.includes('explicar') || lowerResponse.includes('detalhes')) {
            actions.push({
                label: 'üîç Mais Detalhes',
                type: 'more_details',
                data: response
            });
        }
        
        return actions;
    }
    
    handleAction(action) {
        switch (action.type) {
            case 'copy_code':
                this.copyCodeToClipboard(action.data);
                break;
            case 'more_details':
                this.requestMoreDetails(action.data);
                break;
        }
    }
    
    copyCodeToClipboard(text) {
        const codeMatch = text.match(/```[\s\S]*?```/);
        if (codeMatch) {
            const code = codeMatch[0].replace(/```\w*\n?/g, '').replace(/```/g, '');
            navigator.clipboard.writeText(code).then(() => {
                this.showTemporaryMessage('‚úÖ C√≥digo copiado!');
            });
        }
    }
    
    requestMoreDetails(context) {
        this.addMessage('user', `Poderia dar mais detalhes sobre: "${context.substring(0, 50)}..."`);
        this.sendUserMessage();
    }
    
    showTemporaryMessage(message) {
        const tempMsg = document.createElement('div');
        tempMsg.className = 'temp-message';
        tempMsg.textContent = message;
        tempMsg.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            z-index: 10000;
        `;
        document.body.appendChild(tempMsg);
        
        setTimeout(() => {
            tempMsg.remove();
        }, 3000);
    }
    
    async getAIResponse(message) {
        // Simula chamada √† API - substitua pela sua implementa√ß√£o real
        return new Promise((resolve) => {
            setTimeout(() => {
                const responses = [
                    `Entendi sua pergunta sobre "${message}". Aqui est√° uma resposta detalhada...`,
                    `Baseado na sua consulta, recomendo a seguinte solu√ß√£o...`,
                    `Para resolver isso, voc√™ pode seguir estes passos...`
                ];
                resolve(responses[Math.floor(Math.random() * responses.length)]);
            }, 1000);
        });
    }
    
    addMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role === 'user' ? 'user-message' : 'ai-message'}`;
        messageDiv.textContent = content;
        this.elements.messages.appendChild(messageDiv);
        this.scrollToBottom();
    }
    
    showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typingIndicator';
        typingDiv.className = 'typing-indicator';
        typingDiv.innerHTML = `
            IA digitando...
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        `;
        this.elements.messages.appendChild(typingDiv);
        this.scrollToBottom();
    }
    
    hideTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }
    
    getErrorMessage(error) {
        console.error('Erro no widget usu√°rio:', error);
        
        const errorMessages = {
            'network': 'üîå Problema de conex√£o. Verifique sua internet.',
            'timeout': '‚è∞ A resposta est√° demorando mais que o normal.',
            'server': 'üõ†Ô∏è Estamos com problemas t√©cnicos.',
            'default': '‚ùå Ocorreu um erro inesperado.'
        };
        
        if (error.name === 'TimeoutError') return errorMessages.timeout;
        if (error.message.includes('Network')) return errorMessages.network;
        if (error.status === 500) return errorMessages.server;
        
        return errorMessages.default;
    }
    
    scrollToBottom() {
        setTimeout(() => {
            this.elements.messages.scrollTop = this.elements.messages.scrollHeight;
        }, 100);
    }
    
    toggleWidget() {
        this.isOpen = !this.isOpen;
        if (this.isOpen) {
            this.elements.window.classList.remove('widget-hidden');
            this.elements.window.classList.add('widget-visible');
            this.elements.input.focus();
        } else {
            this.closeWidget();
        }
    }
    
    closeWidget() {
        this.isOpen = false;
        this.elements.window.classList.remove('widget-visible');
        this.elements.window.classList.add('widget-hidden');
    }
}

// Inst√¢ncia global
let userWidget;
document.addEventListener('DOMContentLoaded', () => {
    userWidget = new UserWidget();
});
/* ==== FIM: user-widget.js ==== */
